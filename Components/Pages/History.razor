@page "/history"
@rendermode InteractiveServer
@using ApexCharts
@using Blazor.Models
@using Blazor.Interfaces
@using Blazor.Models.Enums
@inject ILitterService _litterService

<div class="page-container" style="height: 140vh;">
    <div style="display: flex; gap: 2rem; align-items: flex-start; flex-direction: row;">
        <div class="box-container" style="flex: 1; height: 440px; display: flex; flex-direction: column;">
            @if (cameras.Count == 0 || totalLitterPerCamera is null || totalLitterPerCamera.Count == 0)
            {
                <div class="loading-indicator"
                    style="font-size:2rem; padding:2rem; flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div class="spinner" style="width:48px; height:48px; border-width:8px;"></div>
                    <span style="font-size:2rem; margin-top:1rem; display:block;">Bezig met laden...</span>
                </div>
            }
            else
            {
                <ApexChart TItem="TotalLitterPerCamera" Title="Totaal gedetecteerd afval per camera" Height="400"
                    Options="options">
                    <ApexPointSeries TItem="TotalLitterPerCamera" Items="totalLitterPerCamera" SeriesType="SeriesType.Donut"
                        Name="Total Litter Per Camera" XValue="@(e => e.Location)" YValue="@(e => e.Amount)" />
                </ApexChart>
            }
        </div>
        <div class="box-container" style="flex: 1; height: 440px; display: flex; flex-direction: column;">
            @if (cameras.Count == 0 || totalLitterPerCamera is null || totalLitterPerCamera.Count == 0)
            {
                <div class="loading-indicator"
                    style="flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center;">
                    <div class="spinner"></div>
                    <span>Bezig met laden...</span>
                </div>
            }
            else
            {
                <ApexChart TItem="TotalPerDay" Title="Aantal afval per dag" Height="400">
                    <ApexPointSeries TItem="TotalPerDay" Items="totalPerDays" SeriesType="SeriesType.Heatmap" Name="Glas"
                        XValue="@(e => e.Day.ToString("dd-MM"))" YValue="@(e => e.Glass)" />
                    <ApexPointSeries TItem="TotalPerDay" Items="totalPerDays" SeriesType="SeriesType.Heatmap" Name="Metaal"
                        XValue="@(e => e.Day.ToString("dd-MM"))" YValue="@(e => e.Metal)" />
                    <ApexPointSeries TItem="TotalPerDay" Items="totalPerDays" SeriesType="SeriesType.Heatmap"
                        Name="Organisch" XValue="@(e => e.Day.ToString("dd-MM"))" YValue="@(e => e.Organic)" />
                    <ApexPointSeries TItem="TotalPerDay" Items="totalPerDays" SeriesType="SeriesType.Heatmap" Name="Papier"
                        XValue="@(e => e.Day.ToString("dd-MM"))" YValue="@(e => e.Paper)" />
                </ApexChart>
            }
        </div>
    </div>
    <div class="box-container mt-4" style="height: 80vh;">
        <h3>Recente afvaldetecties</h3>
        @if (recentLitter.Count == 0)
        {
            <p>Er zijn momenteel geen recente afvaldetecties.</p>
        }
        else
        {
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Type</th>
                    <th>Timestamp</th>
                    <th>Confidence</th>
                    <th>Weather</th>
                    <th>Temperature</th>
                    <th>Location</th>
                    <th>IsHoliday</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var litter in recentLitter)
                {
                    <tr>
                        <td>@litter.Id</td>
                        <td>@litter.Type</td>
                        <td>@litter.TimeStamp.ToString("dd-MM-yyyy")</td>
                        <td>@litter.Confidence</td>
                        <td>@litter.Weather</td>
                        <td>@litter.Temperature</td>
                        <td>@litter.IsHoliday</td>
                        <td>@litter.CameraId</td>
                    </tr>
                }
            </tbody>
        }
    </div>
</div>

<style>
    .box-container {
        flex: 3;
        background-color: #ffffff;
        border-radius: 12px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
        padding: 1rem;
    }
</style>

@code {
    private class TotalLitterPerCamera
    {
        public required string Location { get; set; }
        public int Amount { get; set; }
    }

    private class TotalPerDay
    {
        public DateTime Day { get; set; }
        public int Glass { get; set; }
        public int Metal { get; set; }
        public int Organic { get; set; }
        public int Paper { get; set; }
    }

    private List<Camera> cameras = new();
    private List<Litter> recentLitter = new();
    private List<TotalPerDay> totalPerDays = new();
    private List<TotalLitterPerCamera> totalLitterPerCamera = new();
    private ApexChartOptions<TotalLitterPerCamera> options { get; set; } = new();

    protected override async Task OnInitializedAsync()
    {
        await GetCamerasAsync();
        await GetLitterPerCameraAsync();
        await GetLatestLitterAsync();

        options.PlotOptions = new PlotOptions
        {
            Pie = new PlotOptionsPie
            {
                Donut = new PlotOptionsDonut
                {
                    Labels = new DonutLabels
                    {
                        Total = new DonutLabelTotal { FontSize = "24px", Color = "#D807B8", Formatter = @"function (w)
{return w.globals.seriesTotals.reduce((a, b) => { return (a + b) }, 0)}" }
                    }
                }
            }
        };
    }

    private async Task GetLatestLitterAsync()
    {
        var litterResult = await _litterService.GetLatestLittersAsync(100);
        if (litterResult is null)
        {
            @* GENIUS ERROR! *@
            return;
        }
        recentLitter = litterResult;

        totalPerDays = litterResult
        .GroupBy(l => l.TimeStamp.Date)
        .Select(g => new TotalPerDay
        {
            Day = g.Key,
            Glass = g.Count(x => x.LitterCategory == LitterCategory.Glass),
            Metal = g.Count(x => x.LitterCategory == LitterCategory.Metal),
            Organic = g.Count(x => x.LitterCategory == LitterCategory.Organic),
            Paper = g.Count(x => x.LitterCategory == LitterCategory.Paper)
        })
        .OrderBy(x => x.Day)
        .ToList();
    }

    private async Task GetCamerasAsync()
    {
        var cameraResult = await _litterService.GetCamerasAsync();
        if (cameraResult is null)
        {
            @* GENIUS ERROR! *@
            return;
        }
        cameras = cameraResult;
    }

    private async Task GetLitterPerCameraAsync()
    {
        var litterResult = await _litterService.GetAmountPerLocationAsync();
        if (litterResult is null)
        {
            @* GENIUS ERROR! *@
            return;
        }
        foreach (var camera in litterResult)
        {
            var item = new TotalLitterPerCamera
            {
                Amount = camera.Glass + camera.Metal + camera.Organic + camera.Plastic + camera.Paper,
                Location = cameras.Find(c => c.Id == camera.CameraId)?.Location ?? "Onbekend"
            };
            totalLitterPerCamera.Add(item);
        }
    }
}